{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BAi Ganio - Test Question</title>
  <link rel="icon" type="image/x-icon" href="{% static 'core/css/icons8-idea.svg' %}">
  <link rel="stylesheet" href="{% static 'core/css/test_question.css' %}">
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <div class="header-logo">bAIganio</div>
      <div class="header-streak">
        <img src="{% static 'core/css/icons8-fire-48.png' %}?v=2" alt="Flame Icon" class="streak-icon" />
        <span class="streak-number">{{ streak }}</span>
      </div>
    </header>
    <div class="main-content">
      <aside class="app-sidebar">
        <ul class="nav-list">
          <li>
            <a href="{% url 'dashboard' %}" class="nav-item">
              <img src="{% static 'core/css/home.png' %}?v=2" alt="Home Icon" class="nav-icon">
              <span>Home</span>
            </a>
          </li>
          <li>
            <a href="{% url 'ranking' %}" class="nav-item">
              <img src="{% static 'core/css/ranking.png' %}?v=2" alt="Ranking Icon" class="nav-icon">
              <span>Ranking</span>
            </a>
          </li>
          <li>
            <a href="{% url 'test_textbook' %}" class="nav-item active">
              <img src="{% static 'core/css/icons8-test-48.png' %}?v=2" alt="Tests Icon" class="nav-icon">
              <span>Tests</span>
            </a>
          </li>
          <li>
            <a href="{% url 'profile' %}" class="nav-item">
              <img src="{% static 'core/css/profile.png' %}?v=2" alt="Profile Icon" class="nav-icon" />
              <span>Profile</span>
            </a>
          </li>
        </ul>
      </aside>
      <div class="content">
        <div class="test-framework-card"></div>
        <div id="question-container">
          <!-- Question will be dynamically inserted here -->
        </div>
        <script>
          document.addEventListener("DOMContentLoaded", function () {
            const container = document.getElementById("question-container");
            const rawResponse = sessionStorage.getItem("generatedQuestion");

            console.log("Raw response from sessionStorage:", rawResponse);

            if (!rawResponse) {
              container.innerHTML = "<p>–ù—è–º–∞ –Ω–∞–ª–∏—á–µ–Ω –≤—ä–ø—Ä–æ—Å.</p>";
              return;
            }

            try {
              const response = JSON.parse(rawResponse);
              const questionsText = response.question; // Extract the question string
              const questions = questionsText.split(/\n(?=–í—ä–ø—Ä–æ—Å:)/g); // Split into individual questions
              console.log("Parsed questions count:", questions.length);
              questions.forEach((q, i) => console.log(`Q${i + 1}:\n`, q));
              let currentQuestionIndex = 0;

              function renderQuestion(index) {
                if (index >= questions.length) {
                  container.innerHTML = "<p>–¢–µ—Å—Ç—ä—Ç –ø—Ä–∏–∫–ª—é—á–∏!</p>";
                  sessionStorage.removeItem("generatedQuestion");
                  window.location.href = "{% url 'test_result' %}"; // Redirect
                  return;
                }

                const questionBlock = questions[index];
                const lines = questionBlock.split('\n');

                let questionText = "";
                let answers = [];
                let correct = "";

                lines.forEach(line => {
                  if (line.startsWith("–í—ä–ø—Ä–æ—Å:")) {
                    questionText = line.substring("–í—ä–ø—Ä–æ—Å:".length).trim();
                  } else if (/^[–ê–ë–í–ì]\)/.test(line)) {
                    answers.push(line.trim());
                  } else if (line.startsWith("–ü—Ä–∞–≤–∏–ª–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä:")) {
                    correct = line.substring("–ü—Ä–∞–≤–∏–ª–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä:".length).trim();
                  }
                });

                console.log("Question Text:", questionText);
                console.log("Answers:", answers);
                console.log("Correct Answer:", correct);

                let html = `<h2 class="question-title">–¢–µ—Å—Ç –≤—ä–ø—Ä–æ—Å ${index + 1}</h2><p class="question-text">${questionText}</p><form id="question-form">`;

                answers.forEach((answer) => {
                  html += `
                    <label class="answer-option">
                      <input type="radio" name="selected_answer" value="${answer[0]}" required>
                      ${answer}
                    </label>
                  `;
                });

                html += `<button class="submit-button" type="submit">–ü–æ—Ç–≤—ä—Ä–¥–∏</button></form>`;
                container.innerHTML = html;

                document.getElementById("question-form").addEventListener("submit", function (e) {
                  e.preventDefault();
                  const selected = document.querySelector('input[name="selected_answer"]:checked').value;

                  if (selected === correct[0]) {
                    alert("–ü—Ä–∞–≤–∏–ª–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä! üî•");
                  } else {
                    alert("–ì—Ä–µ—à–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä üò¢ –ü—Ä–∞–≤–∏–ª–Ω–∏—è—Ç –±–µ—à–µ: " + correct);
                  }

                  currentQuestionIndex++;
                  renderQuestion(currentQuestionIndex);
                });
              }

              renderQuestion(currentQuestionIndex); // Start with the first question

            } catch (error) {
              console.error("Error parsing JSON:", error);
              container.innerHTML = "<p>–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞—Ç–∞ –Ω–∞ –≤—ä–ø—Ä–æ—Å–∏—Ç–µ.</p>";
            }
          });
        </script>
      </div>
    </div>
  </div>
</body>
</html>
