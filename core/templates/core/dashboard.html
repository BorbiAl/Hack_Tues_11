{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BAi Ganio</title>
  <link rel="icon" type="image/x-icon" href="../static/core/css/icons8-idea.svg">
  <link rel="stylesheet" href="{% static 'core/css/dashboard.css' %}">
</head>

<style>
  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: 'Nunito', sans-serif;
    background-color: #ffffff;
    color: #3d0066;
  }

  .container {
    max-width: 75rem;
    margin: 0 auto;
    padding: 1.25rem;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #3d0066;
    color: #ffffff;
    padding: 1rem 2rem;
    border-radius: 0.625rem;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: 0 0.125rem 0.625rem rgba(0, 0, 0, 0.1);
  }

  .header-logo {
    font-size: 1.5rem;
    font-weight: bold;
  }

  .header-streak {
    display: flex;
    align-items: center;
  }

  .header-streak .icon {
    width: 2rem;
    height: 2rem;
    margin-right: 0.5rem;
  }

  .streak-number {
    font-size: 1.25rem;
    font-weight: bold;
  }

  .main-content {
    display: flex;
    margin-top: 1.25rem;
  }

  .sidebar {
    width: 15rem;
    background-color: #3d0066;
    padding: 1.25rem;
    border-radius: 0.625rem;
    margin-right: 1.25rem;
    box-shadow: 0 0.125rem 0.625rem rgba(0, 0, 0, 0.1);
  }

  .nav-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .nav-item {
    display: flex;
    align-items: center;
    text-decoration: none;
    color: #ffffff;
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    border-radius: 0.625rem;
    transition: background-color 0.3s ease, transform 0.1s ease;
  }

  .nav-item:hover {
    background-color: #c670ff;
    transform: scale(1.02);
  }

  .nav-item:focus {
    outline: 0.125rem solid #d6a800;
    outline-offset: 0.25rem;
  }

  .nav-item:active {
    transform: scale(0.98);
  }

  .nav-item.active {
    background-color: #d6a800;
    color: #3d0066;
  }

  .nav-icon {
    width: 1.5rem;
    height: 1.5rem;
    margin-right: 0.75rem;
  }

  .content {
    flex-grow: 1;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(15rem, 1fr));
    grid-gap: 1.25rem;
  }


  .card {
    background-color: #eec7fc;
    padding: 1.5rem;
    border-radius: 0.625rem;
    box-shadow: 0 0.125rem 0.625rem rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    height: 15rem;
  }

  .card:hover {
    transform: translateY(-0.125rem);
    box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.15);
  }

  .card:active {
    transform: translateY(0);
  }

  .welcome-card h2 {
    margin-top: 0;
    font-size: 1.75rem;
    color: #3d0066;
  }

  .username {
    color: #d6a800;
  }

  .course-card h3 {
    margin-top: 0;
    font-size: 1.5rem;
    color: #3d0066;
  }

  .course-card p {
    font-size: 1.125rem;
    color: #c670ff;
  }


  .streak-card {
    display: flex;
    align-items: center;
  }

  .large-icon {
    width: 3rem;
    height: 3rem;
    margin-right: 1rem;
  }

  .streak-info h3 {
    margin: 0;
    font-size: 1.5rem;
    color: #3d0066;
  }

  .streak-info p {
    margin: 0.25rem 0 0;
    font-size: 1.125rem;
    color: #d6a800;
  }


  .xp-card {
    display: flex;
    align-items: center;
  }

  .small-icon {
    width: 2rem;
    height: 2rem;
    margin-right: 0.75rem;
  }

  .xp-info h3 {
    margin: 0;
    font-size: 1.5rem;
    color: #3d0066;
  }

  .xp-info p {
    margin: 0.25rem 0 0;
    font-size: 1.125rem;
    color: #d6a800;
  }


  .quote-card {
    grid-column: 1 / -1;
    text-align: center;
    font-size: 1.25rem;
    color: #3d0066;
    padding: 1.5rem;
    background-color: #ffffff;
    border: 0.125rem solid #eec7fc;
    border-radius: 7%;
  }

  @media (max-width: 48rem) {
    .main-content {
      flex-direction: column;
    }

    .sidebar {
      width: 100%;
      margin-bottom: 1.25rem;
    }

    .content {
      grid-template-columns: 1fr;
    }

    .footer {
      text-align: center;
      padding: 1.25rem;
      background-color: #3d0066;
      color: #ffffff;
      border-radius: 0.625rem;
    }

    .footer a {
      color: #ffffff;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .footer a:hover {
      color: #d6a800;
    }
  }
</style>

<body>
  <div class="container">
    <!-- Header Section -->
    <header class="header">
      <div class="header-logo">bAIganio</div>
      <div class="header-streak">
        <img src="{% static 'core/css/icons8-fire-48.png' %}?v=2" alt="Flame Icon" class="nav-icon" />
        <span class="streak-number">{{ streak }}</span>
      </div>
    </header>

    <!-- Main Content Section -->
    <div class="main-content">
      <!-- Sidebar -->
      <aside class="sidebar">
        <ul class="nav-list">
          <li>
            <a href="{% url 'dashboard' %}" class="nav-item active">
              <img src="{% static 'core/css/home.png' %}?v=2" alt="Home Icon" class="nav-icon" />
              <span>Home</span>
            </a>
          </li>
          <li>
            <a href="{% url 'ranking' %}" class="nav-item">
              <img src="{% static 'core/css/ranking.png' %}?v=2" alt="Ranking Icon" class="nav-icon" />
              <span>Ranking</span>
            </a>
          </li>
          <li>
          <li>
            <a href="{% url 'test_textbook' %}" class="nav-item">
              <img src="{% static 'core/css/icons8-test-48.png' %}?v=2" alt="Tests Icon" class="nav-icon">
              <span>Tests</span>
            </a>
          </li>
          </li>
          <li>
            <a href="{% url 'profile' %}" class="nav-item">
              <img src="{% static 'core/css/profile.png' %}?v=2" alt="Profile Icon" class="nav-icon" />
              <span>Profile</span>
            </a>
          </li>
        </ul>
      </aside>

      <!-- Content Section -->
      <section class="content">
        <div class="welcome-card card">
          <h2>Hi, <span class="username">{{ username }}</span>!</h2>
          {% if is_first_login %}
          <p>Welcome! Let's start, every lesson takes you one step closer to mastery!</p>
          {% else %}
          <p>Welcome back! Keep going! Every lesson takes you one step closer to mastery!</p>
          {% endif %}
        </div>
        <div class="course-card card">
          <h3>Geography Exam</h3>
          <p><strong>3 days</strong> left to complete your exam prep!</p>
        </div>
        <div class="streak-card card">
          <img src="{% static 'core/css/icons8-fire-48.png' %}?v=2" alt="Flame Icon" class="icon" />
          <div class="streak-info">
            <h3>Daily Streak</h3>
            <p><strong>{{ streak }} days</strong> in a row</p>
          </div>
        </div>
        <div class="quote-card">
          <h3>Schedule a Test</h3>
          <div class="calendar-controls">
            <button id="prev-month">&lt;</button>
            <span id="current-month-year"></span>
            <button id="next-month">&gt;</button>
          </div>
          <div class="calendar" id="calendar">
            <!-- Calendar days will be dynamically generated here -->
          </div>

          <div class="subject-container" id="subject-container">
            <h3>Choose a Subject for <span id="selected-date"></span></h3>
            <select id="subject-select">
              <option value="Math">Math</option>
              <option value="Science">Science</option>
              <option value="History">History</option>
              <option value="Literature">Literature</option>
            </select>
            <button id="save-subject">Save Subject</button>
          </div>
        </div>

        <script>
          document.addEventListener('DOMContentLoaded', () => {
            const calendar = document.getElementById('calendar');
            const subjectContainer = document.getElementById('subject-container');
            const selectedDateSpan = document.getElementById('selected-date');
            const subjectSelect = document.getElementById('subject-select');
            const saveSubjectButton = document.getElementById('save-subject');
            const currentMonthYear = document.getElementById('current-month-year');
            const prevMonthButton = document.getElementById('prev-month');
            const nextMonthButton = document.getElementById('next-month');

            let currentMonth = new Date().getMonth();
            let currentYear = new Date().getFullYear();

            // Fetch saved tests from the backend
            let savedTests = [];

            async function fetchSavedTests() {
              try {
                const response = await fetch(`/api/saved-tests/?month=${currentMonth + 1}&year=${currentYear}`);
                if (response.ok) {
                  const data = await response.json();
                  savedTests = data.tests; // Update saved tests
                  renderCalendar();
                } else {
                  console.error('Failed to fetch saved tests:', response.statusText);
                }
              } catch (error) {
                console.error('Error fetching saved tests:', error);
              }
            }

            async function saveTest(date, subject) {
              try {
                const csrfToken = getCookie('csrftoken');
                const response = await fetch('/api/save-test/', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                  },
                  body: JSON.stringify({ date, subject }),
                });

                if (response.ok) {
                  const newTest = await response.json();
                  savedTests.push(newTest); // Add the new test to the saved tests
                  renderCalendar();
                  alert(`Subject "${subject}" saved for ${date}!`);
                } else {
                  console.error('Failed to save test:', response.statusText);
                }
              } catch (error) {
                console.error('Error saving test:', error);
              }
            }

            function renderCalendar() {
              calendar.innerHTML = '';
              const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
              currentMonthYear.textContent = `${new Date(currentYear, currentMonth).toLocaleString('default', { month: 'long' })} ${currentYear}`;

              for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('calendar-day');
                dayElement.textContent = day;

                // Check if the day has a saved test
                const formattedDate = `${day}/${currentMonth + 1}/${currentYear}`;
                const test = savedTests.find((test) => test.date === formattedDate);
                if (test) {
                  dayElement.classList.add('test-saved');
                  dayElement.title = `Test: ${test.subject}`;
                }

                dayElement.addEventListener('click', () => {
                  // Highlight the selected day
                  document.querySelectorAll('.calendar-day').forEach((el) => el.classList.remove('selected'));
                  dayElement.classList.add('selected');

                  // Show the subject container
                  subjectContainer.classList.add('active');
                  selectedDateSpan.textContent = formattedDate;
                });

                calendar.appendChild(dayElement);
              }
            }

            // Handle month navigation
            prevMonthButton.addEventListener('click', () => {
              if (currentMonth === 0) {
                currentMonth = 11;
                currentYear--;
              } else {
                currentMonth--;
              }
              fetchSavedTests(); // Fetch tests for the new month
            });

            nextMonthButton.addEventListener('click', () => {
              if (currentMonth === 11) {
                currentMonth = 0;
                currentYear++;
              } else {
                currentMonth++;
              }
              fetchSavedTests(); // Fetch tests for the new month
            });

            // Handle saving the subject
            saveSubjectButton.addEventListener('click', () => {
              const selectedDate = selectedDateSpan.textContent;
              const selectedSubject = subjectSelect.value;

              if (selectedDate && selectedSubject) {
                saveTest(selectedDate, selectedSubject);
              }
            });

            // Initial fetch of saved tests
            fetchSavedTests();

            // Helper function to get CSRF token
            function getCookie(name) {
              let cookieValue = null;
              if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                  }
                }
              }
              return cookieValue;
            }
          });
        </script>

        <style>
          .calendar-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
          }

          .calendar-controls button {
            background-color: #3d0066;
            color: #ffffff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            margin: 0 0.5rem;
            font-weight: bold;
          }

          .calendar-controls button:hover {
            background-color: #d6a800;
          }

          .calendar-controls span {
            font-size: 1.25rem;
            font-weight: bold;
          }

          .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
          }

          .calendar-day {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #eec7fc;
            padding: 1rem;
            border-radius: 0.625rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            height: 3rem;
            /* Set a consistent height */
            box-sizing: border-box;
            /* Ensure padding and borders don't affect size */
          }

          .calendar-day:hover {
            background-color: #d6a800;
            color: #ffffff;
            transform: scale(1.05);
            /* Slight scaling effect */
          }

          .calendar-day.selected {
            background-color: #3d0066;
            color: #ffffff;
            transform: none;
            /* Prevent scaling on selection */
          }

          .calendar-day.test-saved {
            background-color: #800080;
            color: #ffffff;
          }

          .subject-container {
            margin-top: 1rem;
            display: none;
            background-color: #ffffff;
            padding: 1rem;
            border-radius: 0.625rem;
            box-shadow: 0 0.125rem 0.625rem rgba(0, 0, 0, 0.1);
          }

          .subject-container.active {
            display: block;
          }

          .subject-container h3 {
            margin-bottom: 1rem;
          }

          .subject-container select,
          .subject-container button {
            padding: 0.75rem;
            border: 1px solid #3d0066;
            border-radius: 0.375rem;
            background-color: white;
            margin-bottom: 1rem;
            box-sizing: border-box;
            /* Ensure consistent sizing */
          }

          .subject-container button {
            background-color: #d6a800;
            color: #3d0066;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
          }

          .subject-container button:hover {
            background-color: #ffce1f;
          }
        </style>
      </section>
    </div>

    <!-- Footer Section -->
    <footer class="footer">
      <p>&copy; 2025 bAIganio. All rights reserved.</p>
    </footer>
  </div>
</body>

</html>